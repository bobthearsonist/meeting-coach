name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  backend-security:
    name: Backend Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install safety bandit
      
      - name: Run safety check
        run: |
          cd backend
          safety check --json || true
      
      - name: Run bandit security scan
        run: |
          cd backend
          bandit -r src/ -f json -o bandit-report.json || true
          cat bandit-report.json
        continue-on-error: true
      
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-security-reports
          path: backend/bandit-report.json
          retention-days: 30

  frontend-security:
    name: Frontend Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run npm audit
        run: |
          cd frontend
          npm audit --json > npm-audit.json || true
          cat npm-audit.json
        continue-on-error: true
      
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-security-reports
          path: frontend/npm-audit.json
          retention-days: 30

  backend-code-quality:
    name: Backend Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pylint radon
      
      - name: Run pylint detailed report
        run: |
          cd backend
          pylint *.py src/ \
            --disable=C0103,C0114,C0115,C0116,R0903,R0912,R0915 \
            --output-format=json > pylint-report.json || true
          cat pylint-report.json
        continue-on-error: true
      
      - name: Calculate code complexity
        run: |
          cd backend
          radon cc src/ -a -s || true
          radon mi src/ -s || true
        continue-on-error: true
      
      - name: Upload quality reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-quality-reports
          path: backend/pylint-report.json
          retention-days: 30

  frontend-code-quality:
    name: Frontend Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run ESLint with report
        run: |
          cd frontend
          npx eslint src/ --format json --output-file eslint-report.json || true
          cat eslint-report.json
        continue-on-error: true
      
      - name: Upload quality reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-quality-reports
          path: frontend/eslint-report.json
          retention-days: 30

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          allow-licenses: MIT, Apache-2.0, BSD-3-Clause, BSD-2-Clause, ISC

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs:
      - backend-security
      - frontend-security
      - backend-code-quality
      - frontend-code-quality
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Code Quality Summary"
          echo ""
          echo "Backend Security: ${{ needs.backend-security.result }}"
          echo "Frontend Security: ${{ needs.frontend-security.result }}"
          echo "Backend Code Quality: ${{ needs.backend-code-quality.result }}"
          echo "Frontend Code Quality: ${{ needs.frontend-code-quality.result }}"
          echo ""
          echo "All quality checks completed. Review artifacts for detailed reports."
