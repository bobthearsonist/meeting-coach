name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

jobs:
  # Backend Jobs
  backend-lint:
    name: Backend Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install black isort pylint flake8
      
      - name: Run black
        run: cd backend && black --check *.py src/ tests/ || true
      
      - name: Run isort
        run: cd backend && isort --check-only *.py src/ tests/ --profile=black || true
      
      - name: Run pylint
        run: cd backend && pylint *.py src/ --disable=C0103,C0114,C0115,C0116,R0903,R0912,R0915 || true
      
      - name: Run flake8
        run: cd backend && flake8 *.py src/ --max-line-length=100 --ignore=E501,W503 || true

  backend-unit-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    needs: backend-lint
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
      
      - name: Run unit tests
        run: |
          cd backend
          pytest tests/unit/ -v -m "unit" --tb=short --disable-warnings

  backend-integration-tests:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    needs: backend-unit-tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
      
      - name: Run integration tests (without external dependencies)
        run: |
          cd backend
          pytest tests/integration/ -v -m "integration and not requires_ollama and not requires_audio" --tb=short --disable-warnings

  # Frontend Jobs
  frontend-lint:
    name: Frontend Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run ESLint
        run: cd frontend && npm run lint

  frontend-unit-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    needs: frontend-lint
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run unit tests
        run: |
          cd frontend
          npm test -- --watchAll=false --testPathIgnorePatterns=integration

  frontend-integration-tests:
    name: Frontend Integration Tests
    runs-on: ubuntu-latest
    needs: frontend-unit-tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run integration tests (if any exist)
        run: |
          cd frontend
          npm test -- --watchAll=false --testMatch="**/*.integration.test.js" || echo "No integration tests found"

  # Summary Job
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: 
      - backend-lint
      - backend-unit-tests
      - backend-integration-tests
      - frontend-lint
      - frontend-unit-tests
      - frontend-integration-tests
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.backend-lint.result }}" != "success" ]] || \
             [[ "${{ needs.backend-unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.backend-integration-tests.result }}" != "success" ]] || \
             [[ "${{ needs.frontend-lint.result }}" != "success" ]] || \
             [[ "${{ needs.frontend-unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.frontend-integration-tests.result }}" != "success" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All CI jobs passed!"
