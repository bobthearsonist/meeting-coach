name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main, develop ]

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      workflows: ${{ steps.filter.outputs.workflows }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            workflows:
              - '.github/workflows/**'

  backend-quick-check:
    name: Backend Quick Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install black isort
      
      - name: Quick lint check
        run: |
          cd backend
          black --check *.py src/ tests/
          isort --check-only *.py src/ tests/ --profile=black
      
      - name: Run fast tests
        run: |
          cd backend
          pytest tests/unit/ -v -m "unit and not slow" --tb=short --disable-warnings -x

  frontend-quick-check:
    name: Frontend Quick Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Quick lint check
        run: |
          cd frontend
          npm run lint
      
      - name: Run fast tests
        run: |
          cd frontend
          npm test -- --watchAll=false --bail --passWithNoTests

  pr-size-check:
    name: PR Size Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check PR size
        run: |
          # Count changed lines
          CHANGED_LINES=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -n 1 | awk '{print $4+$6}')
          echo "Changed lines: $CHANGED_LINES"
          
          if [ "$CHANGED_LINES" -gt 500 ]; then
            echo "⚠️ This PR is quite large ($CHANGED_LINES lines changed)"
            echo "Consider breaking it into smaller PRs for easier review"
          else
            echo "✅ PR size looks good"
          fi

  pr-title-check:
    name: PR Title Check
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          
          # Check if title follows conventional commits format
          if [[ "$TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?:\ .+ ]]; then
            echo "✅ PR title follows conventional commits format"
          else
            echo "⚠️ PR title should follow conventional commits format"
            echo "Examples: feat: add new feature, fix: resolve bug, docs: update README"
            echo "Current title: $TITLE"
            # Don't fail, just warn
          fi

  pr-checks-summary:
    name: PR Checks Summary
    runs-on: ubuntu-latest
    needs: 
      - changes
      - backend-quick-check
      - frontend-quick-check
      - pr-size-check
      - pr-title-check
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Pull Request Checks Summary"
          echo ""
          echo "Changes detected:"
          echo "- Backend: ${{ needs.changes.outputs.backend }}"
          echo "- Frontend: ${{ needs.changes.outputs.frontend }}"
          echo ""
          
          # Check if any required checks failed
          FAILED=false
          
          if [[ "${{ needs.changes.outputs.backend }}" == "true" ]] && [[ "${{ needs.backend-quick-check.result }}" != "success" ]]; then
            echo "❌ Backend quick check failed"
            FAILED=true
          fi
          
          if [[ "${{ needs.changes.outputs.frontend }}" == "true" ]] && [[ "${{ needs.frontend-quick-check.result }}" != "success" ]]; then
            echo "❌ Frontend quick check failed"
            FAILED=true
          fi
          
          if [[ "$FAILED" == "true" ]]; then
            exit 1
          fi
          
          echo "✅ All PR checks passed!"
