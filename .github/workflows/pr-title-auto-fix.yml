name: Auto-Fix PR Title

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-fix-title:
    name: Auto-Fix PR Title with AI
    runs-on: ubuntu-latest
    # Only run if the PR title validation has failed
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4

      - name: Check if title needs fixing
        id: check-title
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            
            // Check if title follows conventional commit format
            const conventionalCommitRegex = /^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?:\s.+/;
            const needsFix = !conventionalCommitRegex.test(title);
            
            core.setOutput('needs_fix', needsFix);
            core.setOutput('current_title', title);
            
            if (needsFix) {
              console.log(`Title needs fixing: "${title}"`);
            } else {
              console.log(`Title is valid: "${title}"`);
            }

      - name: Analyze PR content and generate new title
        if: steps.check-title.outputs.needs_fix == 'true'
        id: generate-title
        uses: actions/github-script@v7
        with:
          script: |
            const currentTitle = '${{ steps.check-title.outputs.current_title }}';
            const prBody = context.payload.pull_request.body || '';
            
            // Get the list of changed files
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const changedFiles = files.data.map(f => f.filename).join('\n');
            const fileCategories = {
              docs: ['.md', '.txt', 'README', 'LICENSE', 'CONTRIBUTING'],
              test: ['test', 'spec', '__tests__', '.test.', '.spec.'],
              ci: ['.github/workflows', '.github/actions', 'ci.yml', 'cd.yml'],
              build: ['Makefile', 'package.json', 'requirements.txt', 'Dockerfile', 'docker-compose'],
              frontend: ['frontend/', 'src/components/', 'src/screens/', '.jsx', '.tsx'],
              backend: ['backend/', 'api/', 'server/'],
              config: ['config/', '.env', 'settings', '.yml', '.yaml', '.json'],
            };
            
            // Analyze changed files to determine the type
            let suggestedType = 'chore';
            let confidence = 'low';
            
            // Count matches for each category
            const categoryScores = {};
            for (const [category, patterns] of Object.entries(fileCategories)) {
              categoryScores[category] = files.data.filter(f => 
                patterns.some(pattern => f.filename.includes(pattern))
              ).length;
            }
            
            // Determine the most likely type based on file changes
            if (categoryScores.docs > 0 && categoryScores.docs === files.data.length) {
              suggestedType = 'docs';
              confidence = 'high';
            } else if (categoryScores.test > 0 && categoryScores.test === files.data.length) {
              suggestedType = 'test';
              confidence = 'high';
            } else if (categoryScores.ci > 0) {
              suggestedType = 'ci';
              confidence = categoryScores.ci === files.data.length ? 'high' : 'medium';
            } else if (categoryScores.build > 0) {
              suggestedType = 'build';
              confidence = 'medium';
            } else {
              // Analyze title and description for keywords
              const content = (currentTitle + ' ' + prBody).toLowerCase();
              
              if (content.match(/\b(add|new|create|implement|introduce)\b/)) {
                suggestedType = 'feat';
                confidence = 'medium';
              } else if (content.match(/\b(fix|bug|issue|error|patch|resolve)\b/)) {
                suggestedType = 'fix';
                confidence = 'medium';
              } else if (content.match(/\b(refactor|restructure|reorganize|cleanup|clean up)\b/)) {
                suggestedType = 'refactor';
                confidence = 'medium';
              } else if (content.match(/\b(performance|perf|optimize|speed|faster)\b/)) {
                suggestedType = 'perf';
                confidence = 'medium';
              } else if (content.match(/\b(style|format|lint|prettier|eslint)\b/)) {
                suggestedType = 'style';
                confidence = 'medium';
              }
              
              // Frontend vs Backend
              if (categoryScores.frontend > categoryScores.backend) {
                // Keep the type but note it's frontend
              } else if (categoryScores.backend > categoryScores.frontend) {
                // Keep the type but note it's backend
              }
            }
            
            // Clean up the current title to create a better description
            let cleanTitle = currentTitle
              .replace(/^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?:\s*/i, '')
              .trim();
            
            // Capitalize first letter if needed
            cleanTitle = cleanTitle.charAt(0).toUpperCase() + cleanTitle.slice(1);
            
            // Remove trailing punctuation
            cleanTitle = cleanTitle.replace(/[.!?]+$/, '');
            
            const newTitle = `${suggestedType}: ${cleanTitle}`;
            
            core.setOutput('new_title', newTitle);
            core.setOutput('suggested_type', suggestedType);
            core.setOutput('confidence', confidence);
            
            console.log(`Suggested type: ${suggestedType} (confidence: ${confidence})`);
            console.log(`New title: ${newTitle}`);

      - name: Update PR title
        if: steps.check-title.outputs.needs_fix == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const newTitle = '${{ steps.generate-title.outputs.new_title }}';
            const suggestedType = '${{ steps.generate-title.outputs.suggested_type }}';
            const confidence = '${{ steps.generate-title.outputs.confidence }}';
            
            // Update the PR title
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              title: newTitle
            });
            
            // Add a comment to explain the change
            const currentTitleForComment = '${{ steps.check-title.outputs.current_title }}';
            const comment = 'ðŸ¤– **AI PR Title Auto-Fix**\n\n' +
              'I\'ve automatically updated the PR title to follow [Conventional Commits](https://www.conventionalcommits.org/) format:\n\n' +
              '**Previous title:** `' + currentTitleForComment + '`\n' +
              '**New title:** `' + newTitle + '`\n\n' +
              '**Analysis:**\n' +
              '- Suggested type: `' + suggestedType + '`\n' +
              '- Confidence: ' + confidence + '\n\n' +
              'If this isn\'t quite right, you can manually edit the PR title. The format should be:\n' +
              '```\n' +
              '<type>: <description>\n' +
              '```\n\n' +
              'Valid types: `feat`, `fix`, `docs`, `style`, `refactor`, `perf`, `test`, `chore`, `ci`, `build`';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            console.log('âœ… PR title updated and comment posted');
