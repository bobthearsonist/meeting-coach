name: Frontend Tests

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-tests.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-tests.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['18', '20']
    steps:
      - uses: actions/checkout@v4

      - name: Setup Frontend Node.js
        uses: ./.github/actions/setup-frontend-node
        with:
          node-version: ${{ matrix.node-version }}

      - name: Run unit tests
        uses: ./.github/actions/run-frontend-tests

  component-tests:
    name: Component Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    strategy:
      matrix:
        test-path:
          - { name: 'Components', pattern: '**/components/**/*.test.js' }
          - { name: 'Screens', pattern: '**/screens/**/*.test.js' }
    steps:
      - uses: actions/checkout@v4

      - name: Setup Frontend Node.js
        uses: ./.github/actions/setup-frontend-node

      - name: Run ${{ matrix.test-path.name }} tests
        uses: ./.github/actions/run-frontend-tests
        with:
          test-pattern: ${{ matrix.test-path.pattern }}

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: component-tests
    strategy:
      matrix:
        test-path:
          - { name: 'Services', pattern: '**/services/**/*.test.js' }
          - { name: 'Context', pattern: '**/context/**/*.test.js' }
          - { name: 'Integration Suite', pattern: '**/*.integration.test.js', continue: 'true' }
    steps:
      - uses: actions/checkout@v4

      - name: Setup Frontend Node.js
        uses: ./.github/actions/setup-frontend-node

      - name: Run ${{ matrix.test-path.name }} tests
        uses: ./.github/actions/run-frontend-tests
        with:
          test-pattern: ${{ matrix.test-path.pattern }}
          continue-on-error: ${{ matrix.test-path.continue || 'false' }}

  build-test:
    name: Build Verification
    runs-on: macos-latest
    needs: integration-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Frontend Node.js
        uses: ./.github/actions/setup-frontend-node

      - name: Install CocoaPods dependencies
        working-directory: frontend/macos
        run: pod install

      - name: Build macOS app
        working-directory: frontend
        run: npx react-native build-macos --mode Debug
        continue-on-error: true

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      - unit-tests
      - component-tests
      - integration-tests
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Component Tests: ${{ needs.component-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"

          if [[ "${{ needs.unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.component-tests.result }}" != "success" ]] || \
             [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
            echo "❌ One or more test jobs failed"
            exit 1
          fi

          echo "✅ All frontend tests passed!"
