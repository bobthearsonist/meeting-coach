name: Test Coverage

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/coverage.yml'
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  pull-requests: write

jobs:
  backend-coverage:
    name: Backend Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
      
      - name: Run tests with coverage
        run: |
          cd backend
          pytest tests/ \
            -v \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=json \
            --cov-branch \
            -m "not slow and not requires_ollama and not requires_audio"
      
      - name: Generate coverage badge
        run: |
          cd backend
          COVERAGE=$(python -c "import json; print(json.load(open('coverage.json'))['totals']['percent_covered_display'])")
          echo "Coverage: $COVERAGE%"
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage.xml
          flags: backend
          name: backend-coverage
        continue-on-error: true
      
      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage-report
          path: backend/htmlcov/
          retention-days: 14
      
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = fs.readFileSync('backend/coverage.json', 'utf8');
            const coverageData = JSON.parse(coverage);
            const percent = coverageData.totals.percent_covered_display;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Backend Coverage Report\n\nðŸ“Š **Coverage:** ${percent}%\n\n[View detailed report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });
        continue-on-error: true

  frontend-coverage:
    name: Frontend Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run tests with coverage
        run: |
          cd frontend
          npm test -- \
            --coverage \
            --watchAll=false \
            --coverageReporters=text \
            --coverageReporters=lcov \
            --coverageReporters=json-summary \
            --passWithNoTests
      
      - name: Generate coverage badge
        run: |
          cd frontend
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(node -p "require('./coverage/coverage-summary.json').total.lines.pct")
            echo "Coverage: $COVERAGE%"
            echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
          else
            echo "No coverage data found"
          fi
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
        continue-on-error: true
      
      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-coverage-report
          path: frontend/coverage/
          retention-days: 14
      
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request' && hashFiles('frontend/coverage/coverage-summary.json') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = fs.readFileSync('frontend/coverage/coverage-summary.json', 'utf8');
            const coverageData = JSON.parse(coverage);
            const percent = coverageData.total.lines.pct;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Frontend Coverage Report\n\nðŸ“Š **Coverage:** ${percent}%\n\n[View detailed report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });
        continue-on-error: true

  coverage-summary:
    name: Coverage Summary
    runs-on: ubuntu-latest
    needs:
      - backend-coverage
      - frontend-coverage
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Test Coverage Summary"
          echo ""
          echo "Backend Coverage: ${{ needs.backend-coverage.result }}"
          echo "Frontend Coverage: ${{ needs.frontend-coverage.result }}"
          echo ""
          echo "Coverage reports uploaded as artifacts"
